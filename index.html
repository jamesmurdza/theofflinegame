<html>
<head>

<script>
// Force HTTPS
if (location.protocol == 'http:') {
    location.replace(`https:${location.href.substring(location.protocol.length)}`);
}
</script>

<meta name="viewport" content="width=device-width, minimal-ui">

<style>

html {
height: 100%;
}

body {
margin: 0;
max-height: 100%;
background: url(./img/circle-hole.svg) no-repeat center center fixed;
background-size: cover;
height: 100%;
}

.container {
margin: 0 auto;
text-align: center;
max-height: 100%;
}
.screen {
display: none;
position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); min-width:320px;
}
.image {
margin: auto;
}
.image div {
width: 100%;
background-repeat: no-repeat;
background-size: contain;
}
.appicon {
padding-top: 100%;
background: url('./img/icon-wifi.png');
}
.airplanemode {
padding-top: 100%;
background: url('./img/icon-airplanemode.png');
}
.success {
padding-top: 100%;
background: url('./img/icon-success-green.png');
}
.banner {
padding-top: 22.6%;
background: url('./img/logo-handwritten.svg');
}
.banner-results {
padding-top: 24.2%;
background: url('./img/banner-results.png');
}
.background-top {
padding-top: 27.5%;
background: url('./img/circle-top.svg');
margin-bottom: -0%;
}
.background-bottom {
padding-top: 27.5%;
background: url('./img/circle-bottom.svg');
position: static;
bottom: 0;
}
p, a, h1, h2, b {
text-align: center;
padding: 0em 1em 0.3em;
text-transform: uppercase;
font-family: 'Arial Narrow', Arial, Helvetica, sans-serif;
line-height: 1.3;
font-weight: bold;
color: #777;
font-size: 15pt;
margin: 5px 0px;
}
a {
display: inline-block;
text-decoration: none;
color: #fff;
background-color: #db0000;
padding: 0.5em 1em;
font-size: 18pt;
}
a.plain {
color: #000;
background-color: transparent;
}
h1, h2, b {
display: block;
font-size: 24pt;
color: #111;
padding: 0em 1em 0em;
margin: 0;
}
h2, b {
font-size: 22pt;
}
#preload {
display: none;
}
</style>

<title>The Offline Game</title>

<link rel="icon" href="./img/icon-wifi.png">

<meta property="og:title" content="The Offline Game">
<meta property="og:description" content="Play the offline game!">
<meta property="og:image" content="./img/icon-wifi.png">

</head>
<body>

<div class="container">

<div id="preload">
<img src="./img/icon-success-green.png" />
</div>

<div class="screen" id="screen1" style="">
<div class="image" style="width:60%"><div class="appicon"></div></div>
<div class="image" style="width:100%"><div class="banner"></div></div>
<br />
<p id="welcomeText"></p>
<br />
<a href="#" onclick="goToScreen(2); checkOffline()">Try it out</a>
</div>

<div class="screen" id="screen2">
<div class="image" style="width:70%"><div class="airplanemode"></div></div>
<br />
<h2>Start Airplane Mode</h2>
<p>We detect when you disconnect from the internet and start the timer.</p>
</div>

<div class="screen" id="screen3">
<div class="image" style="width:70%"><div class="success"></div></div>
<br />
<p>You have been offline for <b><span id="count3">-</span></b>. Keep this tab open to keep the timer going. Stay focused, and stay offline for as long as you can.</p>
</div>

<div class="screen" id="screen4">
<div class="image" style="width:100%"><div class="banner-results"></div></div>
<p>You were offline for <b><span id="count4">-</span></b> Send your friends a screenshot to brag.</p>
<br />
<a href="#" onclick="shareScore()" id="challengeButton">Challenge friends</a><br />
<a href="#" onclick="updateWelcomeText(); goToScreen(1)" class="plain">Try again</a>
</div>

</div>

<script>

var startTime = 0;
var activeScreenN = 0;
var activeScreen = null;
var timer = null;
var nSeconds;

function getScreen(n)
{
	return document.getElementById("screen" + n);
}

function goToScreen(n)
{
	if (activeScreen)
	{
		activeScreen.style.display = "none";
	}
	activeScreen = getScreen(n);
	activeScreenN = n;
	activeScreen.style.display = "block";
}

function formatDuration(duration) {
//    var sec_num = parseInt(this, 10); // don't forget the second param

    var outputstring = "";

    var hours   = Math.floor(duration / 3600);
    var minutes = Math.floor((duration - (hours * 3600)) / 60);
    var seconds = duration - (hours * 3600) - (minutes * 60);

    if (hours == 1) outputstring += hours + " hour "; 
    if (hours > 1) outputstring += hours + " hours ";
    if (hours > 0)
    {
        if (minutes == 1) outputstring += minutes + " min"; 
        if (minutes > 1) outputstring += minutes + " mins"; 
    }
    else
    {
        if (minutes == 1) outputstring += minutes + " minute"; 
        if (minutes > 1) outputstring += minutes + " minutes"; 
    }
    if (hours == 0 && minutes == 0)
    {
        if (seconds == 1) outputstring += seconds + " second"; 
        else outputstring += seconds + " seconds"; 
    }

    return outputstring;
}

function updateTimer()
{
	var d = new Date();
	nSeconds = Math.round((d.getTime() - startTime)/1000);
    updateUI();
}

function updateUI()
{
	timeString = formatDuration(nSeconds);
	document.getElementById("count3").innerHTML = timeString;
	document.getElementById("count4").innerHTML = timeString;
    if (timer)
    {
        window.document.title = "You've been offline for " + timeString;
    }
    else
    {
        window.document.title = "Your best score was " + timeString;
    }
}

function startTimer()
{
	var d = new Date();
	startTime = d.getTime();
	timer = setInterval(updateTimer, 1000);
    updateTimer();
}

function stopTimer()
{
	clearInterval(timer);	
    timer = null;
}

function checkOffline(event)
{
	if (navigator.onLine)
	{
		if (activeScreenN == 3)
		{
			//goToScreen(4);
            goToScore(nSeconds);
			stopTimer();
		}
	}
	else
	{
		if (activeScreenN == 1 || activeScreenN == 2)
		{
			startTimer();
			goToScreen(3);
		}
	}
}

function getQueryVariable(variable) {
    var query = window.location.search.substring(1);
    var vars = query.split('&');
    for (var i = 0; i < vars.length; i++) {
        var pair = vars[i].split('=');
        if (decodeURIComponent(pair[0]) == variable) {
            return decodeURIComponent(pair[1]);
        }
    }
    return null;
}

var ID = function () {
  // Math.random should be unique because of its seeding algorithm.
  // Convert it to base 36 (numbers + letters), and grab the first 9 characters
  // after the decimal.
  return '_' + Math.random().toString(36).substr(2, 9);
};

function getLocalId() {
    localStorage.clientId = localStorage.clientId || ID();
    return localStorage.clientId;
}

function getReferralId() {
    var referrer = getQueryVariable("r");
    if (referrer != getLocalId())
        return referrer;
    return null;
}

function getScore() {
    if (getQueryVariable("s"))
    {
        return parseInt(getQueryVariable("s"),36);
    }
    return null;
}

function goToScore(score) {
    localStorage.highScore = Math.max(parseInt(localStorage.highScore) || 0, score);
   window.location.search = "?r="+getLocalId()+"&s="+score.toString(36);
}

function updateWelcomeText() {
    if (localStorage.highScore)
    {
    document.getElementById("welcomeText").innerHTML = "You were offline for <b>" + formatDuration(localStorage.highScore) + "</b> Think you can do better?";
    }
    else if (getScore())
    {
    document.getElementById("welcomeText").innerHTML = "Your friend was offline for <b>" + formatDuration(getScore()) + "</b> Think you can do better?";
    }
    else
    {
    document.getElementById("welcomeText").innerHTML = "120 people are offline right now, competing to see who can stay disconnected the longest. Up for the challenge?";
    }
}

function shareScore() {
    var didShare = false;
    if (navigator.share) {
  navigator.share({
/*    title: 'web.dev',
    text: 'Check out web.dev.',
    url: 'https://web.dev/',*/
  })
    .then(() => didShare = true) 
    .catch((error) => console.log('Error sharing', error));
}
if (!didShare)
{
    copyTextToClipboard(window.location);
    document.getElementById("challengeButton").innerHTML = "Copied to clipboard!";
}
}

function fallbackCopyTextToClipboard(text) {
  var textArea = document.createElement("textarea");
  textArea.value = text;
  
  // Avoid scrolling to bottom
  textArea.style.top = "0";
  textArea.style.left = "0";
  textArea.style.position = "fixed";

  document.body.appendChild(textArea);
  textArea.focus();
  textArea.select();

  try {
    var successful = document.execCommand('copy');
    var msg = successful ? 'successful' : 'unsuccessful';
    console.log('Fallback: Copying text command was ' + msg);
  } catch (err) {
    console.error('Fallback: Oops, unable to copy', err);
  }

  document.body.removeChild(textArea);
}
function copyTextToClipboard(text) {
  if (!navigator.clipboard) {
    fallbackCopyTextToClipboard(text);
    return;
  }
  navigator.clipboard.writeText(text).then(function() {
    console.log('Async: Copying to clipboard was successful!');
  }, function(err) {
    console.error('Async: Could not copy text: ', err);
  });
}

window.addEventListener('online',  checkOffline);
window.addEventListener('offline', checkOffline);

if (!getReferralId() && getScore())
{
    nSeconds = getScore();
    updateUI();
    goToScreen(4);
}
else {
    updateWelcomeText();
    goToScreen(1);
}

</script>

</body>
</html>
